<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="IchtySys es una plataforma intuitiva para la recolección y análisis de datos ictiométricos de sardina. Registra, organiza y visualiza muestreos pesqueros de forma eficiente y segura, optimizando el manejo de información en campo y laboratorio.">
    <link rel="icon" type="image/png" href="IchtySys.png">
    <title>Plataforma de Ictiometría</title>
        h1 { text-align: center; margin: 6px 0 4px 0; }
        body { background-color: silver; display: flex; justify-content: center;}
        #contenido, section, fieldset, .tallas-grid { width: 100%; min-width: 310px; max-width: 420px; box-sizing: border-box; margin-left: auto !important; margin-right: auto !important;}
        section { text-align: center; margin: 5px auto; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 5px;}
        header { position: relative; padding: 6px 16px; min-height: 6px; display: flex; align-items: center; justify-content: center; overflow: hidden;}
        .header-logo { position: absolute; top: 50%; transform: translateY(-50%); width: 70px; height: 70px; z-index: 1; opacity: 0.88; pointer-events: none; user-select: none;}
        .minpesca { left: 2px; width: 90px; height: 95px; }
        .insopesca { right: 3px; }
        .header-texto { position: relative; z-index: 2; width: 100%; text-align: center; display: flex; flex-direction: column; justify-content: center; pointer-events: auto; }
        header h2, header h3 { margin: 0; padding: 0; line-height: 1.1; color: white; text-shadow: 3px 3px 12px #000, 0 0 6px #000, 0 0 2px #000, 2px 2px 2px #222;}
        .sardina2 { top: 550px; right: 100px; width: 130px; cursor: pointer; }
        .btn { padding: 2px; border-radius: 5px; font-size: 20px; font-weight: 800; color: #fff; cursor: pointer; width: 78px; height: 30px; transition: background 0.18s; text-shadow: 2px 2px 8px #000, 0 0 2px #000, 0 0 1px #000;}
        .counter { font-size: 12px; font-weight: bold; margin-left: 10px; }
        #totalClick { font-size: 45px; font-weight: 800; font-family: 'Franklin Gothic Medium', 'Arial Narrow', 'Arial', 'sans-serif'; margin: 4px 0 3px 0;}
        .boton { color: white; border: none; border-radius: 5px; text-shadow: 2px 2px 5px black; padding: 2px 10px; position: relative; z-index: -1;}
        .boton-porcentaje { background: #181818; color: #fff; border: none; border-radius: 5px; font-weight: bold; padding: 1px 10px;}
        .dm { background-color: black; color: white; border: none; border-radius: 5px;}
        .blackbotton, #btnClear { border: 2px solid; border-radius: 5px; height: 25px; font-weight: 800; background-color: black; color: white;}
        .tallas-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 5px;}
        .tallas-grid .btn, .tallas-grid .blackbotton { width: 100%; min-width: unset; max-width: unset; margin: 0; box-sizing: border-box;}
        .accion-peq { font-size: 15px !important; font-weight: 700; height: 25px; padding: 2px 0;}
        section > div:not(.tallas-grid) { margin-top: 2px; margin-bottom: 2px;}
        fieldset:last-of-type { margin-top: 7px;}
        label { color: #444;}
        .percentageRange1 { color: red;}
        .percentageRange2 { color: blue;}
        .cm { margin: 0px;}
        #modalResponsables, #modalPuertos { display: none; position: fixed; z-index: 2000; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(40,60,44,0.20); align-items: center; justify-content: center;}
        #modalResponsables .cuadro, #modalPuertos .cuadro { background: #fff; padding: 16px 18px; border-radius: 8px; min-width: 280px; max-width: 340px; margin: auto; font-size: 13px; box-shadow: 0 8px 40px #0006;}
        #modalResponsables h4, #modalPuertos h4 { margin-bottom: 10px; font-size: 14px;}
        .responsables-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px 12px; margin-bottom: 13px;}
        .responsables-grid label { display: flex; align-items: center; height: 27px; padding-right: 4px; font-size: 13px; white-space: nowrap; cursor: pointer;}
        .responsables-grid input[type=checkbox] { margin-right: 7px; flex-shrink: 0;}
        #modalResponsables .btn-modal, #modalPuertos .btn-modal { font-size: 14px; padding: 3px 16px; margin-right: 8px; border-radius: 5px; border: none; background: #75bb78; color: #fff; font-weight: bold; transition: background 0.15s; display: block;
    margin: 18px auto 0 auto;}
        #modalResponsables .btn-modal:hover, #modalPuertos .btn-modal:hover { background: #257725;}
        #responsableMuestreo, #puerto { cursor:pointer; background:#fff; }
        .mini-obs-popup { position: absolute; background: #f7fff4; border: 1px solid #cce9cd; border-radius: 7px; font-size: 13px; padding: 8px 8px 8px 9px; margin-top: 1px; z-index: 1001; display: none; box-shadow: 0 2px 10px #3332; min-width: 310px; max-width: 330px; text-align: left;}
        .mini-obs-popup label { margin-right: 4px; }
        .mini-obs-popup input[type="text"], .mini-obs-popup input[type="number"] { width: 65px; font-size: 13px; margin-right: 7px; padding: 2px 2px; border-radius: 4px; border: 1px solid #bbb;}
        .mini-obs-popup input[type="number"] { width: 54px;}
        .mini-obs-popup input#obsMillas { width: 45px; }
        .mini-obs-popup input#obsManual { width: 85px; }
        .mini-obs-popup .btn-mini { font-size: 13px; width: auto; padding: 1px 9px; border-radius: 4px; height: 24px; margin-right: 5px; background: #ff5f55; color: #fff; border: none;}
        .mini-obs-popup .btn-mini:hover { background: #ffb3b3;}
        fieldset { position: relative;}
        #fecha-hora-superpuesta { position: absolute; right: 2px; top: -3px; margin: 2px; z-index: 8;}
        #fecha-hora-superpuesta div { color: #fff; font-weight: 900; letter-spacing: 1px; text-shadow: 2px 2px 7px #000, 1px 1px 1px #111; font-size: 0.93em; line-height: 1.05; -webkit-text-stroke: 1.1px #111; border: none;}
        #fecha-sardina { margin-bottom: 3px;}
        .puerto-bloque { margin-left: -90px; display: inline-block;}
        .puertos-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 18px; margin-bottom: 14px; max-width: 310px;}
        .puertos-grid label { display: flex; align-items: center; padding: 3px 0 3px 0; font-size: 13px; white-space: nowrap;}
        .modal-acceso { display: none; position: fixed; z-index: 30000; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(40,50,70,0.8); align-items: center; justify-content: center;}
        .modal-acceso-dialogo { background: #fff; border-radius: 15px; box-shadow: 0 10px 32px #3335; width: 97%; max-width: 368px; padding: 28px 22px 20px 22px; position: relative; display: flex; flex-direction: column; align-items: stretch; animation: fadeInUp .25s;}
        .modal-acceso-dialogo h2 { margin-top: 0; font-size: 1.14em; font-weight: 900; text-align: center;}
        .modal-acceso-cerrar { position: absolute; right: 9px; top: 5px; background: none; border: none; font-size: 1.5em; color: #b22; cursor: pointer;}
        .modal-acceso-form { display: flex; flex-direction: column; gap: 11px; align-items: stretch;margin-top:12px;}
        .modal-acceso-form label { font-size: 1em;margin-bottom: 2px;}
        .modal-acceso-form input[type=password], .modal-acceso-form input[type=text] { font-size: 1em; padding: 7px 8px; border-radius: 7px; border: 1px solid #bbb; margin-bottom: 2px;}
        .modal-acceso-btn { background: linear-gradient(90deg, #e25c48 0, #f19479 100%); color: #fff; border-radius: 8px; border: none; font-weight: 700; font-size: 1.04em; padding: 8px 0; margin-top: 13px; letter-spacing: 0.7px; cursor: pointer; transition: .12s;}
        .modal-acceso-btn:active, .modal-acceso-btn:hover { background: #fa4545; color: #fff;}
        #puerto { text-align: center; background: #fff !important; border-radius: 12px !important; border: 1.5px solid #520000; transition: background 0.18s, color 0.18s; color: #333; font-weight: bold;}
        #puerto.puerto-completo { background: radial-gradient(ellipse at center, #fff 0%, #181818 90%); color: #fff;}
        #modalSeleccionRango { display:none; position:fixed; z-index:10000; top:0; left:0; width:100vw; height:100vh; background:rgba(40,50,70,0.18); align-items: center; justify-content: center;}
        #modalSeleccionRango .modal-rango-dialogo { background:#fff; border-radius:12px; padding:24px 20px 14px 20px; box-shadow:0 6px 28px #1113; text-align:center; min-width: 210px;}
        .btn-modal-corte { font-size: 1.14em; font-weight: 700; margin: 5px 8px 5px 0; padding: 5px 19px; background: #ff7d5a; color: #fff; border: none; border-radius: 5px; transition: background 0.18s; cursor:pointer;}
        .btn-modal-corte:hover { background:#e04b10; }
        header h2 { font-size: 2.1rem; }
        header h3.titulo-pequeno { font-size: 1rem; font-weight: 400; opacity: 0.98; margin-top: 2px; }
        #modalResponsables h4 {
    text-align: center;
}

.centrar-grafico {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%;
  /* opcional: */
  margin-bottom: 12px;
}


#fecha-hora-superpuesta {
  position: absolute;
  right: 2px;
  top: -3px;
  margin: 2px;
  z-index: 8;
}

#input-fecha-hora-manual {
  resize: none;
  outline: none;
  background: none;
  border: none;
  box-shadow: none;
  text-align: right;  /* El texto adentro va a la derecha */
  font-size: 0.93em;
  line-height: 1.05;
  color: #fff;
  font-weight: 900;
  letter-spacing: 1px;
  text-shadow: 2px 2px 7px #000, 1px 1px 1px #111;
  -webkit-text-stroke: 1.1px #111;
  width: 160px;
  height: 38px;
  overflow: hidden;
  font-family: inherit;
  padding: 0;
  margin: 0;        /* <--- NO margen */
  vertical-align: top;
}

/* Estilos para la introducción (degradado invertido) */
        #introduccion {
            background: radial-gradient(ellipse at center, #007bff, #111); /* Azul eléctrico en el centro, azul oscuro en los bordes */
            color: white;
            text-align: center;
            padding: 50px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
        }

        #introduccion h1 {
            font-size: 3em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px #000000;
        }

        #introduccion p {
            font-size: 1.2em;
            margin-bottom: 30px;
            text-shadow: 1px 1px 2px #000000;
        }

        #introduccion button {
            padding: 10px 20px;
            font-size: 1.2em;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Estilos para el modal de acceso (centrar correctamente) */
        .modal-acceso {
            display: none; /* Inicialmente oculto, se muestra con JS */
            position: fixed;
            z-index: 30000;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(40, 50, 70, 0.8);
            align-items: center;
            justify-content: center;
        }

        .modal-acceso-dialogo {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 32px #3335;
            width: 97%;
            max-width: 368px;
            padding: 28px 22px 20px 22px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            animation: fadeInUp .25s;
            margin: auto; /* Centrado */
        }

    </style>
</head>
<body>
<!-- Sección de introducción -->
    <div id="introduccion">
        <h1>Bienvenido a IchtySys</h1>
        <p>Plataforma intuitiva para la recolección y análisis de datos ictiométricos de sardina.</p>
        <button onclick="document.getElementById('introduccion').style.display = 'none';">Comenzar</button>
    </div>
    
<!-- === MODAL DE ACCESO === -->
<div id="modalAcceso" class="modal-acceso" role="dialog" aria-modal="true">
    <div class="modal-acceso-dialogo">
        <button class="modal-acceso-cerrar">&#10006;</button>
        <h2>Seleccione Estado, Puerto<br>y clave de acceso</h2>
        <div class="modal-acceso-form">
            <div>
                <label><input type="radio" name="estadoAcceso" value="Sucre" checked> Sucre</label>
                <label style="margin-left: 18px;"><input type="radio" name="estadoAcceso" value="Nueva Esparta"> Nueva Esparta</label>
            </div>
            <div id="modalAccesoPuertos" style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:5px 14px;"></div>
            <input type="password" id="modalClavePuerto" autocomplete="off" placeholder="Contraseña" />
            <button id="modalBtnAcceso" class="modal-acceso-btn" type="button">Entrar</button>
        </div>
    </div>
</div>

<!-- === MODAL DE RESPONSABLES === -->
<div id="modalResponsables">
    <div class="cuadro">
        <h4>Responsable(s): (máx. 3)</h4>
        <div class="responsables-grid" id="checkGridResp"></div>
        <button id="btnRespOK" type="button" class="btn-modal">Aceptar</button>
    </div>
</div>
<!-- === MODAL DE RANGO PORCENTAJE === -->
<div id="modalSeleccionRango">
    <div class="modal-rango-dialogo">
        <p style="font-weight:700; font-size:1.1em;">Selecciona punto de corte</p>
        <button class="btn-modal-corte" onclick="cambiarRangoPorcentaje(17)">17</button>
        <button class="btn-modal-corte" onclick="cambiarRangoPorcentaje(18)">18</button>
        <button class="btn-modal-corte" onclick="cambiarRangoPorcentaje(19)">19</button><br>
        <button style="margin-top:12px; padding:2px 16px; border-radius:6px; background:#eee; border:1px solid #bbb;" onclick="document.getElementById('modalSeleccionRango').style.display='none'">Cancelar</button>
    </div>
</div>

<div id="contenido">
<header>
    <img src="./minpesca.png" alt="MinPesca" class="header-logo minpesca" />
    <div class="header-texto">
        <h2>
            <b><span class="palabra-con-sombra">IchtySys</span></b>
        </h2>
        <h3 class="titulo-pequeno">
            <span>Plataforma de Ictiometría</span>
        </h3>
    </div>
    <img src="./insopesca.png" alt="Insopesca" class="header-logo insopesca" />
</header>
<section>
    <fieldset>
        <legend><button id="btnLimpiar" class="dm">Datos del Muestreo</button></legend>
        <div class="puerto-bloque">
          <label for="puerto">Puerto:</label>
          <input type="text" id="puerto" name="puerto" required style="width: 132px;" readonly />
        </div>
        
        <div id="fecha-hora-superpuesta">
  <textarea id="input-fecha-hora-manual"
    rows="2"
    autocomplete="off"
    placeholder="Fecha y Hora..."
    spellcheck="false"
    maxlength="48"
  ></textarea>
</div>


  

        <br />
        <label for="duenoEmbarcacion">Dueño y Embarcación:</label> <input type="text" id="duenoEmbarcacion" name="duenoEmbarcacion" list="listaDuenoEmbarcacion" style="width: 300px;" /> <datalist id="listaDuenoEmbarcacion"></datalist>
        <label for="responsableMuestreo">Responsable del Muestreo:</label>
        <div style="position:relative;display:inline-block;width:300px">
          <input type="text" id="responsableMuestreo" name="responsableMuestreo" style="width: 300px;" readonly autocomplete="off" />
        </div>
        <br />
        <label for="observaciones">Observaciones:</label>
        <div style="position:relative;display:inline-block;">
          <textarea id="observaciones" name="observaciones" style="width: 300px; height: 18px; font-size: 10px; font-family: 'sans-serif'; font-weight: bold; line-height: 0.9" autocomplete="off"></textarea>
          <div class="mini-obs-popup" id="popupObserva">
            <label>Norte de</label>
            <input type="text" id="obsZona" placeholder="Zona" />
            <label>a</label>
            <input type="text" id="obsMillas" placeholder="millas" />
            <label>millas, </label>
            <label>Litros ⛽</label>
            <input type="number" min="0" id="obsLitros" placeholder="Litros" />
            <label>Lance</label>
            <input type="number" min="1" id="obsLance" placeholder="N°" style="width:34px;" />
            <label>Cajas</label>
            <input type="number" min="0" id="obsCajas" placeholder="Cajas" style="width:44px;" />
            <label style="margin-left:6px;">
                <input type="checkbox" id="obsRemuestreo" /> REMUESTREO
            </label>
            <input type="text" id="obsManual" placeholder="Observación" style="margin-left:8px;" />
            <button type="button" id="limpiarObservacionPopup" class="btn-mini" style="background: #eee; color:#333; border:1px solid #bbb; margin-right:5px;">
  Limpiar</button>
            <button type="button" id="aceptarObs" class="btn-mini">Aceptar</button>
          </div>
        </div>
    </fieldset>
    <div class="tallas-grid">
        <button class="btn" data-size="12">12<span id="count12" class="counter">0</span></button>
        <button class="btn" data-size="12.5">12.5<span id="count12.5" class="counter">0</span></button>
        <button class="btn" data-size="13">13<span id="count13" class="counter">0</span></button>
        <button class="btn" data-size="13.5">13.5<span id="count13.5" class="counter">0</span></button>
        <button class="btn" data-size="14">14<span id="count14" class="counter">0</span></button>
        <button class="btn" data-size="14.5">14.5<span id="count14.5" class="counter">0</span></button>
        <button class="btn" data-size="15">15<span id="count15" class="counter">0</span></button>
        <button class="btn" data-size="15.5">15.5<span id="count15.5" class="counter">0</span></button>
        <button class="btn" data-size="16">16<span id="count16" class="counter">0</span></button>
        <button class="btn" data-size="16.5">16.5<span id="count16.5" class="counter">0</span></button>
        <button class="btn" data-size="17">17<span id="count17" class="counter">0</span></button>
        <button class="btn" data-size="17.5">17.5<span id="count17.5" class="counter">0</span></button>
        <button class="btn" data-size="18">18<span id="count18" class="counter">0</span></button>
        <button class="btn" data-size="18.5">18.5<span id="count18.5" class="counter">0</span></button>
        <button class="btn" data-size="19">19<span id="count19" class="counter">0</span></button>
        <button class="btn" data-size="19.5">19.5<span id="count19.5" class="counter">0</span></button>
        <button class="btn" data-size="20">20<span id="count20" class="counter">0</span></button>
        <button class="btn" data-size="20.5">20.5<span id="count20.5" class="counter">0</span></button>
        <button class="btn" data-size="21">21<span id="count21" class="counter">0</span></button>
        <button class="btn" data-size="21.5">21.5<span id="count21.5" class="counter">0</span></button>
        <button class="btn" data-size="22">22<span id="count22" class="counter">0</span></button>
        <button class="btn" data-size="22.5">22.5<span id="count22.5" class="counter">0</span></button>
        <button class="btn" data-size="23">23<span id="count23" class="counter">0</span></button>
        <button id="btnClear" class="blackbotton accion-peq">Limpiar</button>
    </div>
    <h1><span class="range-name"><b>TOTAL</b></span></h1>
    <p id="totalClick">0</p>
    
    <div>
        <span class="range-name"><button class="boton"><b>≤15cm</b></button></span>
        <p id="totalRango12-12.5-13-13.5-14-14.5-15-15.5" class="cm"></p>
    </div>
    <div>
        <span class="range-name"><button class="boton"><b>16cm</b></button></span>
        <p id="totalRango16-16.5" class="cm"></p>
    </div>
    <div>
        <span class="range-name"><button class="boton"><b>17cm</b></button></span>
        <p id="totalRango17-17.5" class="cm"></p>
    </div>
    <div>
        <span class="range-name"><button class="boton"><b>18cm</b></button></span>
        <p id="totalRango18-18.5" class="cm"></p>
    </div>
    <div>
        <span class="range-name"><button class="boton"><b>≥19cm</b></button></span>
        <p id="totalRango19-19.5-20-20.5-21-21.5-22-22.5-23" class="cm"></p>
    </div><br />
    
    <div id="graficoPorcentajeRangos" style="width:40%; min-width:56px; margin-left:7px; margin-bottom: 10px;">
    <!-- JS genera aquí la barra y los porcentajes -->
</div>

    <img src="./sardina2.png" alt="" class="sardina2" />
    <fieldset>
        <legend><b>Porcentaje del Muestreo</b></legend>
        <div>
            <span class="range-name">
                <button class="boton-porcentaje" id="btnRangoMenor" type="button"><b>(<17)</b></button>
            </span>
            <a id="totalRango12-16.5"></a>
            <span class="percentageRange1"><b id="percentageRange1"></b></span>
            <span class="range-name">-/- 
                <button class="boton-porcentaje" id="btnRangoMayor" type="button"><b>(≥17)</b></button>
            </span>
            <a id="totalRango17-23"></a>
            <span class="percentageRange2"><b id="percentageRange2"></b></span>
        </div>

    </fieldset>
    <p>
        <h5><center>
  © <span id="copyright-trigger" style="text-decoration:underline;cursor:pointer;">Insopesca El Morro</span>
</center></h5>
    </p>
    <p>
        <h6><center>
            <a href="mailto:creativapaginaweb@gmail.com">creativapaginaweb@gmail.com</a>
        </center></h6>
    </p>
    
    <div id="modal-analisis" style="display:none;position:fixed;z-index:11000;left:0;top:0;width:100vw;height:100vh;background:rgba(30,45,80,0.4);align-items:center;justify-content:center;">
  <div style="background:#fff;width:98vw;max-width:480px;max-height:95vh;overflow-y:auto;position:relative;padding:24px 18px 18px 18px;border-radius:13px;box-shadow:0 12px 55px #1117;">
    <button id="cerrar-analisis" style="position:absolute;right:12px;top:8px;font-size:20px;background:none;border:none;cursor:pointer;color:#d44;">&times;</button>
    <h3 style="margin-top:0;text-align:center;color:#1976d2;">Resumen del Muestreo</h3>
    <div id="analisis-formulario" style="font-size:12px; margin-bottom:16px;"></div>
    <div class="centrar-grafico">
    <canvas id="grafica-tipos-talla" style="max-width:340px;"></canvas>
    <canvas id="grafica-barras-talla" style="margin-top:16px;max-width:340px;"></canvas></div>
    <div id="analisis-leyenda" style="margin-top:16px;font-size:13.5px;color:#222;"></div>
  </div>
</div>

<button type="button" id="btn-analisis-graficas" style="margin: 10px auto 18px auto; padding: 6px 18px; border-radius: 7px; border: none; background: #3a6fd6; color: #fff; font-weight: 700; cursor: pointer; width: 200px;">Ver resumen y gráficas</button>

</section>
</div>

<script>
    // ========== DATOS POR PUERTO ==========
const PUERTO_OPCIONES = {
    "El Morro": {
        duenosEmbarcaciones: [
            "Omar León - Constituyente", "Jesús Suárez - Divino Niño", "Andy Bellorín - Doña Betty",
            "Luis Marval - Doña Güicha", "Lorenzo Rodríguez - El Carlin", "José Vásquez - El Pelícano",
            "Manuel Álvarez - El Playero", "Ramón Montaño - Elimar", "Obdulio Beroní - Eucelis Crismar",
            "Tort Gutiérrez - Fuerza India", "Germán R. Torres - Germancito", "Germán Rodríguez - Germancito",
            "Hernán Salazar - Guaicaipuro", "Lauriannys Brito - Jhogelvis", "Luis Suárez - Llegó Chus",
            "Miraidis Rodríguez - Los Ojos de Dios", "Rosa García - Mis 4 Hijos III", "Ramona Salazar - Los Pelaos",
            "Domingo Lugo - Los Pelones", "José Lugo - Mi Omaira", "Diorsy Fernández - Mi Valentina",
            "Alpidio Moreno - Miche Gollo", "Jairo Gutiérrez - Morro Blanco I", "Neptalí Marcano - Neplidis",
            "Lino Jauri - Elohim", "Henderson Navarro - Picho José", "Miguel Navarro - El Cazador",
            "Francisco Rodríguez - San Francisco", "Eglis Rodríguez - También Va", "Mireglis Rodríguez - Mi Fe en Dios",
            "Ismael López - Unión IV", "Olaidys Carrillo - Yo Mismo Soy", "Kenny Gutiérrez - Quién Soy Yo",
            "José Marval - Sigan Criticando", "Jesús Rivera - Yorako", "Asdrúbal Vargas - Envidiame Más",
            "Donny Montaño - Doña Francisca", "Noel Lugo - Mi Norelvi", "Juan Brito - Dios No Olvida",
            "Miguel Brito - Alcatraz", "Emperatriz Gil - El Petaquero", "Octavio Brito - El Tavarín",
            "Johan Brito - El Padre es Dios", "Liborio Peregrino - Mis 6 Hijos", "Sucesión Lugo de González - Mis 11 Hijos",
            "Adriana Carreño - Mis 4 Hijos", "Cooperativa Gavilán - Unión de Mis Hijos", "Eunibis García - Urimare",
            "Eugenis García - Yo y Mis 2 Hijos", "Robert Montaño - Los Ciros", "Ana Jiménez - El Isleño",
            "Diannerys Salazar - Mamá Mirelys", "Albin Suárez - Andino IV", "Delmar Villarroel - Derma I",
            "Ramón Moreno - Don Alpidio", "Gerson Gómez - Doña Arinda", "Robert Cedeño - Doña Zuleida",
            "Ramón Rodríguez - El Japonés", "José Lander - Los Mochitos", "Teresa Laffontt - La Yiyi",
            "Argelis León - Mi Valentina", "Christian Velloni - Mis Negros", "Maribel Salazar - Lindo y Bello"
        ],
        responsables: [
            "Alexander Alfonzo","Andreina Amarista","Emmanuel Manosalva","Johan Rosas",
            "José Salazar","Juan Núñez","Juan Salazar","Luis Bastidas","Luis Narváez",
            "Ricardo Sánchez","Rosannys González","Yessika Alfonzo"
        ]
    },
    "Araya": {
        duenosEmbarcaciones: [
            "Pedro Rivas - La Sirena", "Joel Martínez - El León Marino"
        ],
        responsables: [
            "Manuel González", "Carmen Medina", "Luis Romero"
        ]
    },
    "Cumaná": {
        duenosEmbarcaciones: [
            "Ricardo Pérez - El Amanecer", "Lucía Fernández - La Gaviota Azul"
        ],
        responsables: [
            "Paola Valdez", "José Torres"
        ]
    },
    "Guaca": {
        duenosEmbarcaciones: [
            "Carlos Salazar - La Esperanza", "Mario Brito - Sol Naciente"
        ],
        responsables: [
            "Sandra Morales", "Juan Nieves"
        ]
    },
    "Guayacán": {
        duenosEmbarcaciones: [
            "Rosa López - Espíritu Marino", "Antonio Gil - El Bravo"
        ],
        responsables: [
            "Diana Gil", "Jorge González"
        ]
    },
    "La Esmeralda": {
        duenosEmbarcaciones: [
            "Beatriz Rivero - La Esmeralda Bella", "Carlos Lugo - Mar Adentro"
        ],
        responsables: [
            "Mario Arocha", "Lucía Moreno"
        ]
    },
    "Bella Vista": {
        duenosEmbarcaciones: [
            "Oscar Marcano - Timón de Dios", "Rafael Gil - El Pescador"
        ],
        responsables: [
            "Reina Herrera", "Tomás Romero"
        ]
    },
    "Guayacán-Manzanillo": {
        duenosEmbarcaciones: [
            "Yolanda Gutiérrez - Anclas Fuertes", "César Ramos - Marejada"
        ],
        responsables: [
            "Maikol Figueroa", "José Montaño"
        ]
    },
    "Isla de Coche": {
        duenosEmbarcaciones: [
            "Javier Hernández - Coche Dandy", "Laura Herrera - El Océano"
        ],
        responsables: [
            "Ana Delgado", "Roberto Figueroa"
        ]
    },
    "La Galera": {
        duenosEmbarcaciones: [
            "Gloria Marín - Náutica Virgen del Valle", "Patricio Marcano - Punta Este"
        ],
        responsables: [
            "Juan Carlos Materán", "Sonia Ramos"
        ]
    },
    "Manzanillo": {
        duenosEmbarcaciones: [
            "Nancy Guerra - Faro de Esperanza", "Ernesto Navarro - Brisa Libertadora"
        ],
        responsables: [
            "Jesús Varela", "Nelly Morillo"
        ]
    },
    "Pampatar": {
        duenosEmbarcaciones: [
            "Rafael Salazar - Litoral Caribe", "Carolina Azuaje - Gran Navegante"
        ],
        responsables: [
            "Pedro Moya", "Jennifer Sánchez"
        ]
    },
    "Valdez": {
        duenosEmbarcaciones: [
            "Esteban Herrera - Sol y Sal", "Irene Marval - Fénix"
        ],
        responsables: [
            "Samuel Cedeño", "María González"
        ]
    }
};

const estadosPuertos = {
    "Sucre": ["Araya", "Cumaná", "El Morro", "Guaca", "Guayacán", "La Esmeralda"],
    "Nueva Esparta": ["Bella Vista", "Guayacán-Manzanillo", "Isla de Coche", "La Galera", "Manzanillo", "Pampatar", "Valdez"]
};
const claveGeneral = "20124815";
const clavesPuerto = { "El Morro": "mps115e" };
Object.values(estadosPuertos).flat().forEach(p => { if (!clavesPuerto[p]) clavesPuerto[p]=p; });

let puertoSeleccionado = "";
let puertoAutenticado = false;
let modoCambioPuerto = false;
const modal = document.getElementById("modalAcceso");
const modalPuertosBox = document.getElementById("modalAccesoPuertos");
const modalBtnAcceso = document.getElementById("modalBtnAcceso");
const inputClave = document.getElementById("modalClavePuerto");
const datalist = document.getElementById('listaDuenoEmbarcacion');
const inputResp = document.getElementById('responsableMuestreo');

// ==== MANEJO DE PUERTO Y ACCESO ====
function actualizarCamposPorPuerto(nuevoPuerto) {
    const opcionesDuenos = PUERTO_OPCIONES[nuevoPuerto]?.duenosEmbarcaciones || [];
    datalist.innerHTML = '';
    opcionesDuenos.forEach(function(item){
        const option = document.createElement('option');
        option.value = item;
        datalist.appendChild(option);
    });
    window.responsables = PUERTO_OPCIONES[nuevoPuerto]?.responsables || [];
    document.getElementById('duenoEmbarcacion').value = '';
    document.getElementById('responsableMuestreo').value = '';
}
function renderPuertosAcceso(estado, preselect=null) {
    modalPuertosBox.innerHTML = "";
    estadosPuertos[estado].forEach(nombre => {
        const id = "mp_" + nombre.replace(/\W/g, "_");
        modalPuertosBox.innerHTML += `<label><input type="radio" name="puertoAcceso" value="${nombre}" id="${id}"> ${nombre}</label>`;
    });
    let primerRadio = modalPuertosBox.querySelector("input[type=radio]");
    if(preselect && modalPuertosBox.querySelector('input[value="'+preselect+'"]')) {
        primerRadio = modalPuertosBox.querySelector('input[value="'+preselect+'"]');
    }
    if(primerRadio) primerRadio.checked = true;
}
function mostrarModalAcceso(cambioPuerto=false) {
    modoCambioPuerto = !!cambioPuerto;
    let preselectPuerto = "";
    let preselectEstado = "Sucre";
    if(modoCambioPuerto && document.getElementById("puerto")) {
        preselectPuerto = document.getElementById("puerto").value.trim();
        for (let estado in estadosPuertos) {
            if (estadosPuertos[estado].includes(preselectPuerto)) preselectEstado = estado;
        }
        document.querySelectorAll('input[name="estadoAcceso"]').forEach(rb=>{rb.checked = rb.value===preselectEstado;});
    }
    renderPuertosAcceso(preselectEstado, preselectPuerto);
    inputClave.value = "";
    modal.style.display = "flex";
    setTimeout(()=>inputClave.focus(), 130);
}
document.querySelectorAll('input[name="estadoAcceso"]').forEach(rb=>{
    rb.addEventListener('change',function(){ renderPuertosAcceso(this.value); });
});
document.querySelector(".modal-acceso-cerrar").onclick = function (e) {
    if (!puertoAutenticado) {
        e.preventDefault();
        inputClave.focus();
    } else if (modoCambioPuerto) {
        modal.style.display = "none";
    }
};
modalBtnAcceso.onclick = function () {
    const selectedPuerto = modalPuertosBox.querySelector('input[name="puertoAcceso"]:checked');
    if (!selectedPuerto) { alert("Seleccione un puerto."); return; }
    const pass = inputClave.value.trim();
    const nuevoPuerto = selectedPuerto.value;
    const claveCorrecta = pass === claveGeneral || pass === clavesPuerto[nuevoPuerto];
    if (claveCorrecta) {
        puertoAutenticado = true;
        document.getElementById("contenido").style.display = "block";
        const inputPuerto = document.getElementById("puerto");
        if (inputPuerto) {
            inputPuerto.value = nuevoPuerto;
            inputPuerto.readOnly = true;
        }
        puertoSeleccionado = nuevoPuerto;
        modal.style.display = "none";
        modoCambioPuerto = false;
        actualizarCamposPorPuerto(nuevoPuerto);
        
    } else {
        alert("Contraseña incorrecta para el puerto '" + nuevoPuerto + "'.\nRecuerde usar mayúsculas, tildes y espacios exactos.");
        inputClave.value = "";
        inputClave.focus();
    }
};
window.addEventListener("DOMContentLoaded", function(){
    mostrarModalAcceso(false);
    actualizarCamposPorPuerto("El Morro");
    window.responsables = PUERTO_OPCIONES["El Morro"]?.responsables || [];
});
document.addEventListener("focusin", function (e) {
    if (!puertoAutenticado && !modal.contains(e.target)) {
        modal.style.display = "flex";
        inputClave.focus();
    }
});
const inputPuerto = document.getElementById('puerto');
inputPuerto.readOnly = true;
inputPuerto.style.cursor = "pointer";
inputPuerto.addEventListener('focus', function() {
    if(puertoAutenticado) mostrarModalAcceso(true);
});
inputPuerto.addEventListener('click', function() {
    if(puertoAutenticado) mostrarModalAcceso(true);
});

// ======== FECHA Y HORA SUPERPUESTA Y EDICIÓN OCULTA ========
let fechaHoraClickCount = 0;
let fechaEditable = false;
// Evita sobreescribir la fecha si está en modo input

// ===== MODAL RESPONSABLES =====
const modalResp = document.getElementById('modalResponsables');
const checkGrid = document.getElementById('checkGridResp');
const btnRespOK = document.getElementById('btnRespOK');
function openModalResp() {
    checkGrid.innerHTML = '';
    const current = inputResp.value.split(',').map(x=>x.trim()).filter(x=>x.length>0);
    (window.responsables || []).forEach(function(responsable) {
        const label = document.createElement('label');
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.value = responsable;
        if(current.includes(responsable)) chk.checked = true;
        chk.onchange = function() {
            let cks = checkGrid.querySelectorAll('input:checked');
            if(cks.length>3){
                chk.checked=false;
                alert('Máximo 3 responsables.');
            }
        };
        label.appendChild(chk);
        label.appendChild(document.createTextNode(' ' + responsable));
        checkGrid.appendChild(label);
    });
    modalResp.style.display='flex';
}
btnRespOK.onclick = function() {
    const seleccionados = Array.from(checkGrid.querySelectorAll('input:checked')).map(x=>x.value);
    if(seleccionados.length==0){
        alert("Selecciona al menos uno."); return;
    }
    inputResp.value = seleccionados.join(', ');
    modalResp.style.display='none';
};
inputResp.addEventListener('focus', openModalResp);
inputResp.addEventListener('click', openModalResp);
window.addEventListener('mousedown', function(e){
    if(modalResp.style.display==='flex' && !modalResp.contains(e.target) && e.target!==inputResp){
        modalResp.style.display='none';
    }
});

// MINI POPUP OBSERVACIONES RÁPIDAS (¡¡BLOQUE ACTUALIZADO!!)
const observa = document.getElementById('observaciones');
const popupObs = document.getElementById('popupObserva');
const aceptarObs = document.getElementById('aceptarObs');
const limpiarObservacionPopup = document.getElementById('limpiarObservacionPopup');
limpiarObservacionPopup.onclick = function() { document.getElementById('observaciones').value = '';
};
let obsUltimoFueAceptar = false;
observa.addEventListener('focus', mostrarMiniObs);
observa.addEventListener('click', mostrarMiniObs);
function mostrarMiniObs() {
    if (obsUltimoFueAceptar) { obsUltimoFueAceptar = false; return; }
    popupObs.style.display = "block";
    popupObs.style.left = "0px";
    popupObs.style.top = (observa.offsetHeight + 4) + "px";
    document.getElementById('obsZona').focus();
}
aceptarObs.onclick = function () {
    let zona = document.getElementById('obsZona').value.trim();
    let millas = document.getElementById('obsMillas').value.trim();
    let litros = document.getElementById('obsLitros').value.trim();
    let lance = document.getElementById('obsLance').value.trim();
    let cajas = document.getElementById('obsCajas').value.trim();
    let remuestreo = document.getElementById('obsRemuestreo').checked;
    let manual = document.getElementById('obsManual').value.trim();
    let partes = [];
    if(zona) {
        let texto = "Norte de " + zona;
        if(millas) texto += ", a " + millas + " millas";
        partes.push(texto);
    } else if(millas) {
        partes.push("a " + millas + " millas");
    }
    if(litros) partes.push(litros + " litros");
    if(lance) partes.push("⛗ Lance " + lance);
    if(cajas) partes.push("Cajas " + cajas);
    if(remuestreo) partes.push("REMUESTREO");
    if(manual) partes.push(manual);
    let resultado = partes.join(', ');
    if(resultado){
        if(observa.value.trim()) {
            observa.value = observa.value.replace(/\s+$/, '') + "\n" + resultado;
        } else {
            observa.value = resultado;
        }
    }
    popupObs.style.display = 'none';
    document.getElementById('obsZona').value="";
    document.getElementById('obsMillas').value="";
    document.getElementById('obsLitros').value="";
    document.getElementById('obsLance').value="";
    document.getElementById('obsCajas').value="";
    document.getElementById('obsRemuestreo').checked = false;
    document.getElementById('obsManual').value="";
    obsUltimoFueAceptar = true;
};
document.addEventListener('mousedown', function(e){
    if(popupObs.style.display==='block' && !popupObs.contains(e.target) && e.target!==observa){
        popupObs.style.display='none';
    }
});

// ======================= TALLAS, CONTADORES Y RANGOS =========================
// (TODO EL RESTO DE TU CÓDIGO SIN CAMBIOS... desde aquí sigue igual)

var buttons = document.querySelectorAll('button.btn');
var counters = document.querySelectorAll('.counter');
var btnClear = document.getElementById('btnClear');
var btnLimpiar = document.getElementById('btnLimpiar');
var totalElm = document.getElementById('totalClick');
var sizeCounts = {};
var sizeRanges = {
    "12-16.5": ["12","12.5","13","13.5","14","14.5","15","15.5","16","16.5"],
    "17-23": ["17","17.5","18","18.5","19","19.5","20","20.5","21","21.5","22","22.5","23"]
};
const rango15 = ["12","12.5","13","13.5","14","14.5","15","15.5"];
const rango16 = ["16","16.5"];
const rango17 = ["17","17.5"];
const rango18 = ["18","18.5"];
const rango19 = ["19","19.5","20","20.5","21","21.5","22","22.5","23"];
var counts = { "12-16.5": 0, "17-23": 0 };
function actualizarContadoresRangos() {
    counts["12-16.5"] = 0; counts["17-23"] = 0;
    for(var size in sizeCounts){
        if(sizeRanges["12-16.5"].includes(size)) counts["12-16.5"] += sizeCounts[size];
        if(sizeRanges["17-23"].includes(size)) counts["17-23"] += sizeCounts[size];
    }
    document.getElementById('totalRango12-16.5').textContent = counts["12-16.5"];
    document.getElementById('totalRango17-23').textContent = counts["17-23"];
}
function actualizarContadoresBotonesRango() {
    let total15=0,total16=0,total17=0,total18=0,total19=0;
    for(let size in sizeCounts){
        if(rango15.includes(size)) total15 += sizeCounts[size];
        if(rango16.includes(size)) total16 += sizeCounts[size];
        if(rango17.includes(size)) total17 += sizeCounts[size];
        if(rango18.includes(size)) total18 += sizeCounts[size];
        if(rango19.includes(size)) total19 += sizeCounts[size];
    }
    document.getElementById('totalRango12-12.5-13-13.5-14-14.5-15-15.5').textContent = total15;
    document.getElementById('totalRango16-16.5').textContent = total16;
    document.getElementById('totalRango17-17.5').textContent = total17;
    document.getElementById('totalRango18-18.5').textContent = total18;
    document.getElementById('totalRango19-19.5-20-20.5-21-21.5-22-22.5-23').textContent = total19;
}
btnClear.onclick = function() {
    document.getElementById('duenoEmbarcacion').value = '';
    document.getElementById('responsableMuestreo').value = '';
    document.getElementById('observaciones').value = '';
    document.getElementById('obsZona').value = '';
    document.getElementById('obsLitros').value = '';
    document.getElementById('obsLance').value = '';
    document.getElementById('obsCajas').value = '';
    sizeCounts = {};
    counters.forEach(function(counter){ counter.textContent = 0; });
    totalElm.textContent = 0;
    counts["12-16.5"]=0; counts["17-23"]=0;
    document.getElementById('totalRango12-16.5').textContent=0;
    document.getElementById('totalRango17-23').textContent=0;
    document.getElementById('totalRango12-12.5-13-13.5-14-14.5-15-15.5').textContent=0;
    document.getElementById('totalRango16-16.5').textContent=0;
    document.getElementById('totalRango17-17.5').textContent=0;
    document.getElementById('totalRango18-18.5').textContent=0;
    document.getElementById('totalRango19-19.5-20-20.5-21-21.5-22-22.5-23').textContent=0;
    document.getElementById('percentageRange1').textContent='';
    document.getElementById('percentageRange2').textContent='';
    calculatePercentages();
};
btnLimpiar.onclick = function() {
    document.getElementById('puerto').value = '';
    document.getElementById('duenoEmbarcacion').value = '';
    document.getElementById('responsableMuestreo').value = '';
    document.getElementById('observaciones').value = '';
    document.getElementById('obsZona').value = '';
    document.getElementById('obsLitros').value = '';
    document.getElementById('obsLance').value = '';
    document.getElementById('obsCajas').value = '';
};

// ========== RANGO DINÁMICO "PORCENTAJE DEL MUESTREO" ==========
const RANGOS_DISPONIBLES = {
    17: {
        nombreMenor: '(<17)', nombreMayor: '(≥17)',
        menor: ["12","12.5","13","13.5","14","14.5","15","15.5","16","16.5"],
        mayor: ["17","17.5","18","18.5","19","19.5","20","20.5","21","21.5","22","22.5","23"]
    },
    18: {
        nombreMenor: '(<18)', nombreMayor: '(≥18)',
        menor: ["12","12.5","13","13.5","14","14.5","15","15.5","16","16.5","17","17.5"],
        mayor: ["18","18.5","19","19.5","20","20.5","21","21.5","22","22.5","23"]
    },
    19: {
        nombreMenor: '(<19)', nombreMayor: '(≥19)',
        menor: ["12","12.5","13","13.5","14","14.5","15","15.5","16","16.5","17","17.5","18","18.5"],
        mayor: ["19","19.5","20","20.5","21","21.5","22","22.5","23"]
    }
};
let corteActual = 17;
document.getElementById('btnRangoMenor').onclick = document.getElementById('btnRangoMayor').onclick = function() {
    document.getElementById('modalSeleccionRango').style.display = 'flex';
};
const TEMAS = {
    17: { // Rango 17: Rojo
        header: 'radial-gradient(ellipse at center, #ffe6e6 0%, #ff7f7f 40%, #ff0000 65%, red 100%)',
        btn: '#ff7f7f',
        btnHover: 'red',
        boton: 'radial-gradient(ellipse at center, #ffe6e6 0%, #ff7f7f 65%, red 100%)',
        blackbotton: '#8b0000'
    },
    18: { // Rango 18: Azul
        header: 'radial-gradient(ellipse at center, #ebf8ff 0%, #64a2e2 40%, #0066cc 65%, blue 100%)',
        btn: '#70b8ff',
        btnHover: 'blue',
        boton: 'radial-gradient(ellipse at center, #ebf8ff 0%, #64a2e2 40%, blue 90%, blue 100%)',
        blackbotton: '#0051ad'
    },
    19: { // Rango 19: Verde
        header: 'radial-gradient(ellipse at center, #a8ffb1 0%, #38b871 12%, #216144 70%, #153c27 100%)',
        btn: '#6ed76e',
        btnHover: '#217821',
        boton: 'radial-gradient(ellipse at center, #a8ffb1 0%, #38b871 65%, #216144 100%)',
        blackbotton: '#217821'
    }
};

function oscurecerColor(color) {
    let rgb = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(color);
    rgb = rgb ? {
        r: parseInt(rgb[1], 16),
        g: parseInt(rgb[2], 16),
        b: parseInt(rgb[3], 16)
    } : null;
    if (!rgb) return color;
    rgb.r = Math.max(0, rgb.r - 0.1 * rgb.r);
    rgb.g = Math.max(0, rgb.g - 0.1 * rgb.g);
    rgb.b = Math.max(0, rgb.b - 0.1 * rgb.b);
    return '#' + ((1 << 24) + (rgb.r << 16) + (rgb.g << 8) + rgb.b).toString(16).slice(1);
}

function aplicarTema(tema) {
    document.querySelector('header').style.background = tema.header;
    document.querySelectorAll('.btn').forEach(btn => {
        btn.style.backgroundColor = tema.btn;
        btn.style.boxShadow = 'inset 2px 2px 4px rgba(0,0,0,0.3)'; // Sombra interna
        btn.addEventListener('mouseover', ()=>{btn.style.backgroundColor = tema.btnHover;});
        btn.addEventListener('mouseout', ()=>{btn.style.backgroundColor = tema.btn;});
    });
    document.querySelectorAll('.boton').forEach(btn => btn.style.background = tema.boton);
    document.querySelectorAll('.blackbotton').forEach(btn => btn.style.borderColor = tema.blackbotton);
    document.getElementById('btnClear').style.borderColor = tema.blackbotton;
    document.getElementById('btnLimpiar').style.backgroundColor = 'black';
}

function cambiarRangoPorcentaje(nuevoCorte) {
    corteActual = nuevoCorte;
    document.getElementById('btnRangoMenor').innerHTML = `<b>${RANGOS_DISPONIBLES[corteActual].nombreMenor}</b>`;
    document.getElementById('btnRangoMayor').innerHTML = `<b>${RANGOS_DISPONIBLES[corteActual].nombreMayor}</b>`;
    document.getElementById('modalSeleccionRango').style.display = 'none';
    calculatePercentages();
    aplicarTema(TEMAS[corteActual]);
}

// Llamada inicial para aplicar el tema por defecto
aplicarTema(TEMAS[corteActual]);

function calculatePercentages(){
    const totalCount = parseInt(totalElm.textContent);
    let menor = 0, mayor = 0;
    const rangos = RANGOS_DISPONIBLES[corteActual];
    for(let size in sizeCounts){
        if(rangos.menor.includes(size)) menor += sizeCounts[size];
        if(rangos.mayor.includes(size)) mayor += sizeCounts[size];
    }
    document.getElementById('totalRango12-16.5').textContent = menor;
    document.getElementById('totalRango17-23').textContent = mayor;
    const p1 = totalCount > 0 ? (menor / totalCount) * 100 : 0;
    const p2 = totalCount > 0 ? (mayor / totalCount) * 100 : 0;
    document.getElementById('percentageRange1').textContent = p1.toFixed(0) + '%';
    document.getElementById('percentageRange2').textContent = p2.toFixed(0) + '%';
    actualizarBarraPorcentaje();
}
buttons.forEach(function(button){
    button.onclick = function(){
        var size = button.dataset.size;
        sizeCounts[size] = (sizeCounts[size] || 0) + 1;
        button.querySelector('.counter').textContent = sizeCounts[size];
        totalElm.textContent = parseInt(totalElm.textContent, 10) + 1;
        actualizarContadoresRangos();
        actualizarContadoresBotonesRango();
        calculatePercentages();
    };
});
calculatePercentages();
actualizarContadoresRangos();
actualizarContadoresBotonesRango();

function actualizarBarraPorcentaje() {
    const v1 = parseFloat((document.getElementById('percentageRange1').textContent || "0").replace('%','')) || 0;
    const v2 = parseFloat((document.getElementById('percentageRange2').textContent || "0").replace('%','')) || 0;
    document.getElementById('graficoPorcentajeRangos').innerHTML = `
      <div style="width:100%;height:15px;background:#eaeaea;border-radius:8px;overflow:hidden;display:flex;">
        <div style="background:#e03;width:${v1}%;height:100%;"></div>
        <div style="background:#3a6fd6;width:${v2}%;height:100%;"></div>
      </div>
      <div style="width:100%; display:flex; justify-content:space-between; font-size:14px; font-weight:700; margin:3px 0 1px 0;">
        <span style="color:#e03;">${v1}%</span>
        <span style="color:#3a6fd6;">${v2}%</span>
      </div>
    `;
}




// Mostrar modal al hacer click en el copyright
document.addEventListener('DOMContentLoaded', function() {
  var trigger = document.getElementById('copyright-trigger');
  var modal = document.getElementById('legal-modal');
  var closeBtn = document.getElementById('legal-close');
  if (trigger && modal && closeBtn) {
    trigger.onclick = function() {
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    };
    closeBtn.onclick = function() {
      modal.style.display = 'none';
      document.body.style.overflow = '';
    };
    modal.addEventListener('click', function(e) {
      if (e.target === this) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }
    });
  }
});


</script>

<div id="legal-modal" style="display:none;position:fixed;z-index:10000;left:0;top:0;width:100vw;height:100vh;background:rgba(12,18,25,0.46);align-items:center;justify-content:center;">
  <div style="background:#fff;max-width:500px;width:94vw;max-height:90vh;overflow-y:auto;padding:22px 18px 18px 18px;box-shadow:0 12px 55px #1115;border-radius:13px;position:relative;font-size:13.2px;">
    <button id="legal-close" style="position:absolute;right:14px;top:8px;font-size:21px;background:none;border:none;color:#c22;cursor:pointer;">&times;</button>
    <h3 style="margin-top:0;text-align:center;">Aviso de Derechos de Autor</h3>
    <p>
      Aunque este sitio web y su contenido aparecen bajo el nombre de © Insopesca El Morro con el objetivo de apoyar y representar a la inspectoría donde trabajo, declaro lo siguiente:
    </p>
    <b>Cláusula I: Propiedad del Código y Funcionalidad</b>
    <p>
      El código fuente, las funcionalidades, el diseño y toda la lógica subyacente de este sitio web han sido creados y desarrollados íntegramente por Emmanuel Manosalva. Todas las mejoras, modificaciones y adaptaciones futuras deberán ser autorizadas expresamente por su creador.
    </p>
    <b>Cláusula II: Prohibición de Modificación y Alteración</b>
    <p>
      Queda estrictamente prohibida la modificación, alteración, adaptación o reutilización del código fuente y la funcionalidad del sitio web sin el consentimiento previo y por escrito de Emmanuel Manosalva. Cualquier cambio no autorizado podrá ser considerado como una violación de los derechos de autor y será susceptible de acciones legales.
    </p>
    <b>Cláusula III: Uso Exclusivo y Autorización</b>
    <p>
      El uso de este sitio web y su código fuente es exclusivo bajo la autorización de Emmanuel Manosalva. En el caso de que el creador decida retirar su autorización, el uso de la herramienta deberá cesar inmediatamente. El incumplimiento de esta condición podría acarrear consecuencias legales.
    </p>
    <b>Cláusula IV: Prohibición de Copia y Plagio</b>
    <p>
      Queda expresamente prohibida la copia, distribución, plagio o reproducción total o parcial del código fuente y su funcionalidad sin la autorización expresa de Emmanuel Manosalva. Toda infracción a esta disposición será considerada como una violación de los derechos de autor y podrá ser perseguida conforme a la ley.
    </p>
    <p>Este aviso se aplica a todos los usuarios, administradores y terceros relacionados con el sitio web.</p>
    <div style="margin-top:10px;text-align:center;font-size:12.5px;">
      © 2025 Emmanuel Manosalva | Insopesca El Morro
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
   Chart.register(ChartDataLabels);
   
    document.addEventListener("DOMContentLoaded", function() {
  // Abrir y cerrar modal
  document.getElementById('btn-analisis-graficas').onclick = function() {
    mostrarAnalisisModal();
  };
  document.getElementById('cerrar-analisis').onclick = function() {
    document.getElementById('modal-analisis').style.display = 'none';
    document.body.style.overflow = '';
  };
  document.getElementById('modal-analisis').addEventListener('click', function(e){
    if (e.target === this) {
      this.style.display = 'none';
      document.body.style.overflow = '';
    }
  });
});

function mostrarAnalisisModal() {
  document.getElementById('modal-analisis').style.display = 'flex';
  document.body.style.overflow = 'hidden';

  // ----- DATOS DEL FORMULARIO ACTUAL -----
  // Adapta estos a tus campos actuales si cambian nombres de ids
  var puerto = document.getElementById('puerto')?.value || '';
  var fecha = document.getElementById('input-fecha-hora-manual')?.value || '';

  var dueno = document.getElementById('duenoEmbarcacion')?.value || '';
  var responsables = document.getElementById('responsableMuestreo')?.value || '';
  var total = Number(document.getElementById('totalClick')?.textContent) || 0;

  // Asigna las tallas y totales
  var tallas = [
    { nombre: "≤15cm", total: Number(document.getElementById('totalRango12-12.5-13-13.5-14-14.5-15-15.5')?.textContent) || 0 },
    { nombre: "16cm",  total: Number(document.getElementById('totalRango16-16.5')?.textContent) || 0 },
    { nombre: "17cm",  total: Number(document.getElementById('totalRango17-17.5')?.textContent) || 0 },
    { nombre: "18cm",  total: Number(document.getElementById('totalRango18-18.5')?.textContent) || 0 },
    { nombre: "≥19cm", total: Number(document.getElementById('totalRango19-19.5-20-20.5-21-21.5-22-22.5-23')?.textContent) || 0 }
  ];
  var sum = tallas.reduce((a, b) => a + b.total, 0);

  // ----- RESUMEN ARRIBA -----
  var observaciones = document.getElementById('observaciones')?.value || '';
document.getElementById('analisis-formulario').innerHTML =
  `<b>Puerto:</b> ${puerto}<br>
  <b>Fecha:</b> ${fecha}<br>
   <b>Dueño y embarcación:</b> ${dueno}<br>
   <b>Responsables:</b> ${responsables}<br>
   <b>Observaciones:</b> ${observaciones ? observaciones.replace(/\n/g, "<br>") : "Sin observaciones"}<br>
   <b>Total especímenes muestreados:</b> ${total}<br>`;
   
     // 1. DESTRUYE GRAFICOS SI EXISTEN
if (window.graficaTallaTipo) {
  window.graficaTallaTipo.destroy();
  window.graficaTallaTipo = null;
}
if (window.graficaTallaBarras) {
  window.graficaTallaBarras.destroy();
  window.graficaTallaBarras = null;
}

document.getElementById('cerrar-analisis').onclick = function() {
  document.getElementById('modal-analisis').style.display = 'none';
  document.body.style.overflow = '';
  if (window.graficaTallaTipo) {
    window.graficaTallaTipo.destroy();
    window.graficaTallaTipo = null;
  }
  if (window.graficaTallaBarras) {
    window.graficaTallaBarras.destroy();
    window.graficaTallaBarras = null;
  }
};


  // ----- GRAFICA CIRCULAR -----
window.graficaTallaTipo = new Chart(document.getElementById('grafica-tipos-talla').getContext('2d'), {
  type: 'pie',
  data: {
    labels: tallas.map(t => t.nombre),
    datasets: [{
      data: tallas.map(t => t.total),
      backgroundColor: ['#e03', '#ffcb05', '#3a6fd6', '#8be3ec', '#1cab18']
    }]
  },
  options: {
    plugins: {
      legend: {
        display: true,
        position: 'bottom'
      },
      datalabels: {
        color: '#222',
        font: { weight: 'bold', size: 13 },
        formatter: function(value, context) {
          if (!value) return ''; // <-- Oculta 0%
          const data = context.chart.data.datasets[0].data;
          const sum = data.reduce((a, b) => a + b, 0);
          return sum ? Math.round((value * 100) / sum) + '%' : '';
        }
      },
      tooltip: {
        callbacks: {
          label: function(ctx) {
            const data = ctx.chart.data.datasets[0].data;
            const sum = data.reduce((a, b) => a + b, 0);
            const pct = sum ? Math.round((ctx.raw * 100) / sum) : 0;
            return `${ctx.label}: ${ctx.raw} (${pct}%)`;
          }
        }
      }
    }
  },
  plugins: [ChartDataLabels]
});



  // ----- GRAFICA DE BARRAS -----
  window.graficaTallaBarras = new Chart(document.getElementById('grafica-barras-talla').getContext('2d'), {
  type: 'bar',
  data: {
    labels: tallas.map(t => t.nombre),
    datasets: [{
      label: 'Cantidad por rango de talla',
      data: tallas.map(t => t.total),
      backgroundColor: ['#e03', '#ffcb05', '#3a6fd6', '#8be3ec', '#1cab18']
    }]
  },
  options: {
    indexAxis: 'x',
    plugins: {
      legend: {
        display: true,
        position: 'bottom'
      },
      datalabels: {
        color: '#000',
        font: { weight: 'bold', size: 13 },
        anchor: 'center',
        align: 'center',
        formatter: function(value, context) {
          if (!value) return ''; // <-- Oculta 0%
          const data = context.chart.data.datasets[0].data;
          const sum = data.reduce((a, b) => a + b, 0);
          return sum ? Math.round((value * 100) / sum) + '%' : '';
        }
      },
      tooltip: {
        callbacks: {
          label: function(ctx) {
            const data = ctx.chart.data.datasets[0].data;
            const sum = data.reduce((a, b) => a + b, 0);
            const pct = sum ? Math.round((ctx.raw * 100) / sum) : 0;
            return `${ctx.raw} ejemplares (${pct}%)`;
          }
        }
      }
    },
    scales: {
      y: { beginAtZero: true }
    }
  },
  plugins: [ChartDataLabels]
});




  // ----- COMENTARIO ANÁLISIS AUTOMÁTICO -----
  let rangoMayor = tallas.reduce((a,b)=>b.total>a.total?b:a, {total:0});
  let textoResumen = '';
  if(sum === 0){
    textoResumen = 'No hay datos para analizar aún.';
  } else if(rangoMayor.nombre === '≤15cm'){
    textoResumen = 'Predominan ejemplares pequeños; es probable que la población esté compuesta principalmente por juveniles. Se sugiere monitorear la pesca para evitar sobreexplotación de ejemplares inmaduros.';
  } else if(rangoMayor.nombre === '16cm' || rangoMayor.nombre === '17cm'){
    textoResumen = 'La muestra está dominada por tallas intermedias, lo que puede indicar una estructura de población en crecimiento o presión moderada de pesca.';
  } else if(rangoMayor.nombre === '18cm' || rangoMayor.nombre === '≥19cm'){
    textoResumen = 'Predominan ejemplares grandes; indica una población madura y posiblemente una pesca más selectiva o conservativa sobre tallas mayores.';
  } else {
    textoResumen = 'La distribución de tallas es variada, lo cual es positivo para la salud poblacional de la especie.';
  }
  textoResumen += `<br><i><b>El resumen se genera automáticamente según las frecuencias actuales.</b></i>`;
  document.getElementById('analisis-leyenda').innerHTML = textoResumen;
}

</script>

</body>
</html>
